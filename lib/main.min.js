define("Ticker",["dojo/_base/Deferred","dojo/string","dojo/on","dojo/regexp"],function(p,s,t,z){function e(b){var c={};return function(){var a=JSON.stringify(arguments);if(c[a])return c[a];var d=c[a]=new p;d.then(function(){delete c[a]});b.apply(d,arguments);return d}}var l=128,q=function(b,c,a){return"tickerEvts_"+(b||null)+"_"+(c||null)+"_"+(a||null)},g=function(b,c){var a;try{a=JSON.parse(localStorage[b])}catch(d){return null}if(a&&(!c||(new Date).getTime()-a.time<c))return a.value},n=function(b,
c){localStorage[b]=JSON.stringify({time:(new Date).getTime(),value:c});return c},A=e(function(){var b=g("tickerOpts",18E5);b?this.resolve(b):u({action:"getOpts"}).then(function(c){this.resolve(n("tickerOpts",c))}.bind(this))}),B=e(function(){this.resolve({count:0})}),y=e(function(b,c){var a=g(q(b,c,l),18E5);if(a)this.resolve(a);else{var d=RegExp("^"+q("(null|"+b+")","(\\d+|null)","(\\d+|null)")),a=c&&(g("eventKeys")||[]).filter(function(c){return d.test(c)}).map(function(c){return g(c,18E5)}).filter(function(c){return c!=
null}).map(function(a){return a.filter(function(a){return a.tu<c})}).reduce(function(c,a){return c.concat(a)},[])||0;a.length>=l?(a.sort(function(c,a){return c.tu>a.tu?-1:1}),this.resolve(a)):u({action:"getEvents",filter:b,offset:c&&c*1E3,limit:l}).then(function(a){var f=q(b,c,l);this.resolve(n(f,a));a=g("eventKeys")||[];a.indexOf(f)==-1&&a.push(f);n("eventKeys",a)}.bind(this))}}),h=new p;h.resolve();var u=e(function(b){var c;h.then(function(){dojo.xhrPost({url:"/ticker",content:b}).then(function(a){this.resolve(JSON.parse(a));
c.resolve()}.bind(this))}.bind(this).later(0));c=h=new p}),C='<a href="${url}" class="ticker-link" title="${title}"> </a> <span class="group"><i class="${icon}"> </i> <span><b><i class="${icon}"> </i> ${groupTitle}</b></span></span> ${title_part} <i class="ts"><a href="${url}">${ts}</a></i><div class="clb"> </div>',v={DEFAULT:'<a href="${url}">${title}</a> <span class="user">${user_name}</span>',comments:'<span class="user">${user_name}</span> w <a href="${url}">${title}</a>',answer:'<span class="user">${user_name}</span> odpowiada na <a href="${url}">${title}</a>',
question:'<span class="user">${user_name}</span> zadaje pytanie <a href="${url}">${title}</a>',"project-join":'<span class="user">${user_name}</span> do\u0142\u0105cza do <a href="${url}">${title}</a>'};return{init:function(b){function c(){return Object.keys(f).filter(function(a){return f[a]})}var a=dojo.create("form",{innerHTML:"<label>Filtr:</label>"},b,"first"),d=dojo.create("div",{className:"clb"},a,"last"),j=dojo.create("ul",{},b),f={};A().then(function(b){function e(a,c,b,f){var d=new p;dojo.addClass(r,
"active");d.then(function(){dojo.removeClass(r,"active")}.later(100));c&&(c=RegExp(z.escapeString(c),"gi"));(a&&a[0]&&a||Object.keys(k)).some(function(a){dojo.addClass(k[a].node,"loading")});(!a||!a[0])&&d.then(function(){Object.keys(k).some(function(a){dojo.removeClass(k[a].node,"loading")})});a=a&&a[0]&&a||[null];f||dojo.query(">*",j).orphan();var g=0;a.some(function(a){g++;var m;y(a,b).then(m=function(b){var e=j.firstChild,i=dojo.query("li",j).length;a&&dojo.removeClass(k[a].node,"loading");b.some(function(b){if(!(a&&
b.group!=a))try{var m=k[b.group];b.icon=m.icon;b.groupTitle=m.title;b.title_part=s.substitute(v[m.group]||v[b.group]||v.DEFAULT,b);if(!c||Object.keys(b).some(function(a){if(b[a].match(c))return!0})){var d=dojo.create("li",{innerHTML:s.substitute(C,b)},j);for(d.event=b;e&&e.event.tu>b.tu;)e=e.nextSibling;if(j.lastChild&&j.lastChild.event.tu>b.tu)return!0;else e?dojo.place(d,e,"before"):dojo.place(d,j);if(i++>=32)return!0}}catch(f){console.log(b)}});var h=dojo.query("li",j);!f&&h.length>=32?h.filter(function(a,
b){return b>32}).orphan():b.length==l&&(g++,y(a,b[b.length-1].tu-1).then(m));--g<=0&&d.resolve()}.later(0))});return d}function h(){o.value=null;t.emit(a,"submit",{})}var k={};b.some(function(a){var b=dojo.create("label",{className:"filter",innerHTML:s.substitute('<i class="${icon}"> </i> <b>${title}</b> ',a)},d,"before");B(a.id).then(function(a){a.count>0&&dojo.create("span",{innerHTML:a.count},b,"last")});f[a.id]=g("tickerFilter-"+a.id)==!0;dojo.toggleClass(b,"-filter",f[a.id]);k[a.id]=a;a.node=
b;dojo.query(b).on("click",function(d){d.preventDefault();dojo.toggleClass(b,"-filter");n("tickerFilter-"+a.id,f[a.id]=dojo.hasClass(b,"-filter"));e(c(),o.value)})});var i=dojo.create("label",{className:"util"},a,"first"),r=dojo.create("i",{className:"icon-refresh"},i,"last");dojo.connect(r,"click",function(a){a.preventDefault();[{id:null}].concat(b).some(function(a){a=q(a.id,null,l);localStorage.removeItem(a)});e(c(),o.value)});var i=dojo.create("span",{innerHTML:'<input type="textbox" required placeholder="Szukaj"/><i class="icon-remove-circle"> </i><i class="icon-search"> </i>'},
i,"first"),o=dojo.query("input",i)[0];dojo.query(".icon-search",i).on("click",function(){t.emit(a,"submit",{})});dojo.query(".icon-remove-circle",i).on("click",h);dojo.query("input",i).on("keydown",function(a){a.keyCode==dojo.keys.ESCAPE&&h()});dojo.connect(a,"submit",function(a){a.preventDefault();e(c(),o.value)});e(c(),o.value);var w,x=g("lastPing",26784E5);w=function(){u({action:"ping"}).then(function(a){(!x||x.headTS<a.headTS)&&t.emit(r,"click",{});n("lastPing",x=a)});return w};setInterval(w(),
6E4)})}}});
