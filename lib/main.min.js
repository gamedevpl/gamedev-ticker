define("Ticker",["dojo/_base/Deferred","dojo/string","dojo/on","dojo/regexp"],function(o,r,u,x){function e(b){var c={};return function(){var a=JSON.stringify(arguments);if(c[a])return c[a];var d=c[a]=new o;d.then(function(){delete c[a]});b.apply(d,arguments);return d}}var l=128,p=function(b,c,a){return"tickerEvts_"+(b||null)+"_"+(c||null)+"_"+(a||null)},i=function(b,c){var a;try{a=JSON.parse(localStorage[b])}catch(d){return null}if(a&&(!c||(new Date).getTime()-a.time<c))return a.value},q=function(b,
c){localStorage[b]=JSON.stringify({time:(new Date).getTime(),value:c});return c},y=e(function(){var b=i("tickerOpts",18E5);b?this.resolve(b):v({action:"getOpts"}).then(function(c){this.resolve(q("tickerOpts",c))}.bind(this))}),z=e(function(){this.resolve({count:0})}),w=e(function(b,c){var a=i(p(b,c,l),18E5);if(a)this.resolve(a);else{var d=RegExp("^"+p("(null|"+b+")","(\\d+|null)","(\\d+|null)")),a=c&&(i("eventKeys")||[]).filter(function(c){return d.test(c)}).map(function(c){return i(c,18E5)}).filter(function(c){return c!=
null}).map(function(a){return a.filter(function(a){return a.tu<c})}).reduce(function(c,a){return c.concat(a)},[])||0;a.length>=l?(a.sort(function(c,a){return c.tu>a.tu?-1:1}),this.resolve(a)):v({action:"getEvents",filter:b,offset:c&&c*1E3,limit:l}).then(function(a){var f=p(b,c,l);this.resolve(q(f,a));a=i("eventKeys")||[];a.indexOf(f)==-1&&a.push(f);q("eventKeys",a)}.bind(this))}}),h=new o;h.resolve();var v=e(function(b){var c;h.then(function(){dojo.xhrPost({url:"/ticker",content:b}).then(function(a){this.resolve(JSON.parse(a));
c.resolve()}.bind(this))}.bind(this).later(0));c=h=new o}),A='<a href="${url}" class="ticker-link" title="${title}"> </a> <span class="group"><i class="${icon}"> </i> <span><b><i class="${icon}"> </i> ${groupTitle}</b></span></span> ${title_part} <i class="ts"><a href="${url}">${ts}</a></i><div class="clb"> </div>',s={DEFAULT:'<a href="${url}">${title}</a> <span class="user">${user_name}</span>',comments:'<span class="user">${user_name}</span> w <a href="${url}">${title}</a>',answer:'<span class="user">${user_name}</span> odpowiada na <a href="${url}">${title}</a>',
question:'<span class="user">${user_name}</span> zadaje pytanie <a href="${url}">${title}</a>',"project-join":'<span class="user">${user_name}</span> do\u0142\u0105cza do <a href="${url}">${title}</a>'};return{init:function(b){function c(){return Object.keys(f).filter(function(a){return f[a]})}var a=dojo.create("form",{innerHTML:"<label>Filtr:</label>"},b,"first"),d=dojo.create("div",{className:"clb"},a,"last"),j=dojo.create("ul",{},b),f={};y().then(function(b){function e(a,c,b,f){var d=new o;dojo.addClass(t,
"active");d.then(function(){dojo.removeClass(t,"active")}.later(100));c&&(c=RegExp(x.escapeString(c),"gi"));(a&&a[0]&&a||Object.keys(k)).some(function(a){dojo.addClass(k[a].node,"loading")});(!a||!a[0])&&d.then(function(){Object.keys(k).some(function(a){dojo.removeClass(k[a].node,"loading")})});a=a&&a[0]&&a||[null];f||dojo.query(">*",j).orphan();var g=0;a.some(function(a){g++;var m;w(a,b).then(m=function(b){var e=j.firstChild,i=dojo.query("li",j).length;a&&dojo.removeClass(k[a].node,"loading");b.some(function(b){if(!(a&&
b.group!=a))try{var m=k[b.group];b.icon=m.icon;b.groupTitle=m.title;b.title_part=r.substitute(s[m.group]||s[b.group]||s.DEFAULT,b);if(!c||Object.keys(b).some(function(a){if(b[a].match(c))return!0})){var d=dojo.create("li",{innerHTML:r.substitute(A,b)},j);for(d.event=b;e&&e.event.tu>b.tu;)e=e.nextSibling;if(j.lastChild&&j.lastChild.event.tu>b.tu)return!0;else e?dojo.place(d,e,"before"):dojo.place(d,j);if(i++>=32)return!0}}catch(f){console.log(b)}});var h=dojo.query("li",j);!f&&h.length>=32?h.filter(function(a,
b){return b>32}).orphan():b.length==l&&(g++,w(a,b[b.length-1].tu-1).then(m));--g<=0&&d.resolve()}.later(0))});return d}function h(){n.value=null;u.emit(a,"submit",{})}var k={};b.some(function(a){var b=dojo.create("label",{className:"filter",innerHTML:r.substitute('<i class="${icon}"> </i> <b>${title}</b> ',a)},d,"before");z(a.id).then(function(a){a.count>0&&dojo.create("span",{innerHTML:a.count},b,"last")});f[a.id]=i("tickerFilter-"+a.id)==!0;dojo.toggleClass(b,"-filter",f[a.id]);k[a.id]=a;a.node=
b;dojo.query(b).on("click",function(d){d.preventDefault();dojo.toggleClass(b,"-filter");q("tickerFilter-"+a.id,f[a.id]=dojo.hasClass(b,"-filter"));e(c(),n.value)})});var g=dojo.create("label",{className:"util"},a,"first"),t=dojo.create("i",{className:"icon-refresh"},g,"last");dojo.connect(t,"click",function(a){a.preventDefault();[{id:null}].concat(b).some(function(a){a=p(a.id,null,l);localStorage.removeItem(a)});e(c(),n.value)});var g=dojo.create("span",{innerHTML:'<input type="textbox" required placeholder="Szukaj"/><i class="icon-remove-circle"> </i><i class="icon-search"> </i>'},
g,"first"),n=dojo.query("input",g)[0];dojo.query(".icon-search",g).on("click",function(){u.emit(a,"submit",{})});dojo.query(".icon-remove-circle",g).on("click",h);dojo.query("input",g).on("keydown",function(a){a.keyCode==dojo.keys.ESCAPE&&h()});dojo.connect(a,"submit",function(a){a.preventDefault();e(c(),n.value)});e(c(),n.value)})}}});
