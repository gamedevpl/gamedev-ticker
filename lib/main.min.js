define("Ticker",["dojo/_base/Deferred","dojo/string","dojo/on","dojo/regexp"],function(o,s,t,z){function g(b){var c={};return function(){var a=JSON.stringify(arguments);if(c[a])return c[a];var d=c[a]=new o;d.then(function(){delete c[a]});b.apply(d,arguments);return d}}var l=128,p=function(b,c,a){return"tickerEvts_"+(b||null)+"_"+(c||null)+"_"+(a||null)},d=function(b,c){var a;try{a=JSON.parse(localStorage[b])}catch(d){return null}if(a&&(!c||(new Date).getTime()-a.time<c))return a.value;else a&&c&&
localStorage.removeItem(b)},h=function(b,c){try{localStorage[b]=JSON.stringify({time:(new Date).getTime(),value:c})}catch(a){vacuumStore()}return c},A=g(function(){var b=d("tickerOpts",18E5);b?this.resolve(b):u({action:"getOpts"}).then(function(c){this.resolve(h("tickerOpts",c))}.bind(this))}),B=g(function(){this.resolve({count:0})}),x=g(function(b,c){var a=d(p(b,c,l),18E5);if(a)this.resolve(a);else{var g=RegExp("^"+p("(null|"+b+")","(\\d+|null)","(\\d+|null)")),a=c&&(d("eventKeys")||[]).filter(function(c){return g.test(c)}).map(function(c){return d(c,
18E5)}).filter(function(c){return c!=null}).map(function(a){return a.filter(function(a){return a.tu<c})}).reduce(function(c,a){return c.concat(a)},[])||0;a.length>=l?(a.sort(function(c,a){return c.tu>a.tu?-1:1}),this.resolve(a)):u({action:"getEvents",filter:b,offset:c&&c*1E3,limit:l}).then(function(a){var e=p(b,c,l);this.resolve(h(e,a));a=d("eventKeys")||[];a.indexOf(e)==-1&&a.push(e);h("eventKeys",a)}.bind(this))}}),n=new o;n.resolve();var u=g(function(b){var c;n.then(function(){dojo.xhrPost({url:"/ticker",
content:b}).then(function(a){this.resolve(JSON.parse(a));c.resolve()}.bind(this))}.bind(this).later(0));c=n=new o}),C='<a href="${url}" class="ticker-link" title="${title}"> </a> <span class="group"><i class="${icon}"> </i> <span><b><i class="${icon}"> </i> ${groupTitle}</b></span></span> ${title_part} <i class="ts"><a href="${url}">${ts}</a></i><div class="clb"> </div>',v={DEFAULT:'<a href="${url}">${title}</a> <span class="user">${user_name}</span>',"comment-answer":'<span class="user">${author_name}</span> do <span class="user">${user_name}</span> w <a href="${url}">${title}</a>',
comments:'<span class="user">${user_name}</span> w <a href="${url}">${title}</a>',answer:'<span class="user">${user_name}</span> odpowiada na <a href="${url}">${title}</a>',question:'<span class="user">${user_name}</span> zadaje pytanie <a href="${url}">${title}</a>',"project-join":'<span class="user">${user_name}</span> do\u0142\u0105cza do <a href="${url}">${title}</a>'};return{init:function(b){function c(){return Object.keys(e).filter(function(a){return e[a]})}var a=dojo.create("form",{innerHTML:"<label>Filtr:</label>"},
b,"first"),n=dojo.create("div",{className:"clb"},a,"last"),i=dojo.create("ul",{},b),e={};A().then(function(b){function q(a,c,b,d){var e=new o;dojo.addClass(r,"active");e.then(function(){dojo.removeClass(r,"active")}.later(100));c&&(c=RegExp(z.escapeString(c),"gi"));(a&&a[0]&&a||Object.keys(k)).some(function(a){dojo.addClass(k[a].node,"loading")});(!a||!a[0])&&e.then(function(){Object.keys(k).some(function(a){dojo.removeClass(k[a].node,"loading")})});a=a&&a[0]&&a||[null];d||dojo.query(">*",i).orphan();
var g=0;a.some(function(a){g++;var m;x(a,b).then(m=function(b){var f=i.firstChild,j=dojo.query("li",i).length;a&&dojo.removeClass(k[a].node,"loading");b.some(function(b){if(!(a&&b.group!=a))try{var m=k[b.group];b.icon=m.icon;b.groupTitle=m.title;var d=v[b.group]||v[m.group]||v.DEFAULT;b.title_part=dojo.isFunction(d)?d(b):s.substitute(d,b);if(!c||Object.keys(b).some(function(a){if(b[a].match(c))return!0})){var e=dojo.create("li",{innerHTML:s.substitute(C,b)},i);for(e.event=b;f&&f.event.tu>b.tu;)f=
f.nextSibling;if(i.lastChild&&i.lastChild.event.tu>b.tu)return!0;else f?dojo.place(e,f,"before"):dojo.place(e,i);if(j++>=32)return!0}}catch(g){}});var h=dojo.query("li",i);!d&&h.length>=32?h.filter(function(a,b){return b>32}).orphan():b.length==l&&(g++,x(a,b[b.length-1].tu-1).then(m));--g<=0&&e.resolve()}.later(0))});return e}function y(){j.value=null;j.blur();t.emit(a,"submit",{})}var k={};b.some(function(a){var b=dojo.create("label",{className:"filter",innerHTML:s.substitute('<i class="${icon}"> </i> <b>${title}</b> ',
a)},n,"before");B(a.id).then(function(a){a.count>0&&dojo.create("span",{innerHTML:a.count},b,"last")});e[a.id]=d("tickerFilter-"+a.id)==!0;dojo.toggleClass(b,"-filter",e[a.id]);k[a.id]=a;a.node=b;dojo.query(b).on("click",function(d){d.preventDefault();dojo.toggleClass(b,"-filter");h("tickerFilter-"+a.id,e[a.id]=dojo.hasClass(b,"-filter"));q(c(),j.value)})});var f=dojo.create("label",{className:"util"},a,"first"),r=dojo.create("i",{className:"icon-refresh"},f,"last");dojo.connect(r,"click",function(a){a.preventDefault();
[{id:null}].concat(b).some(function(a){a=p(a.id,null,l);localStorage.removeItem(a)});q(c(),j.value)});var f=dojo.create("span",{innerHTML:'<input type="textbox" required placeholder="Szukaj"/><i class="icon-remove-circle"> </i><i class="icon-search"> </i>'},f,"first"),j=dojo.query("input",f)[0];dojo.query(".icon-search",f).on("click",function(){t.emit(a,"submit",{})});dojo.query(".icon-remove-circle",f).on("click",y);dojo.query("input",f).on("keydown",function(a){a.keyCode==dojo.keys.ESCAPE&&y()});
dojo.connect(a,"submit",function(a){a.preventDefault();q(c(),j.value)});var w=d("lastPing",26784E5);ping=g(function(){u({action:"ping"}).then(function(a){!w||w.headTS<a.headTS?t.emit(r,"click",{}):this.resolve();h("lastPing",w=a)}.bind(this));setTimeout(ping,6E4)});ping().then(function(){q(c(),j.value)})});(function(){(d("eventKeys")||[]).map(function(a){d(a,864E5)}.later())})()}}});
